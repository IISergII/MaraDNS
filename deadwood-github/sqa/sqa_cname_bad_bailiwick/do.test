#!/bin/sh

killall maradns > /dev/null 2>&1 # Don't run this test on Solaris
sleep 2

# 127.1.0.2: example.com
cat > mararc-127.1.0.2 << EOF
chroot_dir="$( pwd )"
ipv4_bind_addresses="127.1.0.2"
csv2 = {}
csv2["example.com."] = "db.example.com"
EOF

cat > db.example.com << EOF
test.% CNAME test.example.net.
test.example.net. 10.5.5.5
EOF

# 127.1.0.3: example.net
cat > mararc-127.1.0.3 << EOF
chroot_dir="$( pwd )"
ipv4_bind_addresses="127.1.0.3"
csv2 = {}
csv2["example.net."] = "db.example.net"
EOF

cat > db.example.net << EOF
test.% 10.7.7.7
EOF

# 127.1.0.4: Root
cat > mararc-127.1.0.4 << EOF
chroot_dir="$( pwd )"
ipv4_bind_addresses="127.1.0.4"
csv2 = {}
csv2["."] = "db.root"
EOF

cat > db.root << EOF
example.net. NS ns.example.net.
ns.example.net. 127.1.0.3
example.com. NS ns.example.com.
ns.example.com. 127.1.0.2
EOF

# OK, test the server
../../../server/maradns -f mararc-127.1.0.2 > /dev/null 2>&1 &
../../../server/maradns -f mararc-127.1.0.3 > /dev/null 2>&1 &
../../../server/maradns -f mararc-127.1.0.4 > /dev/null 2>&1 &
sleep 1

# Now, make sure Deadwood works

cat > dwood3rc << EOF
chroot_dir="$( pwd )"
ipv4_bind_addresses="127.1.0.1"
root_servers = {}
root_servers["."]="127.1.0.4"
recursive_acl="127.0.0.1/8"
resurrections = 0
filter_rfc1918 = 0
EOF

../../src/Deadwood -f dwood3rc > /dev/null &
sleep 1
askmara Atest.example.com. 127.1.0.1

exit 0 # DEBUG

# CLEAN UP
killall maradns
killall Deadwood
rm mararc-*
rm db.*
rm dwood3rc
